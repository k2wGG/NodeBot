{% extends "base.html" %}
{% block title %}–ü–æ—Å—Ç—ã{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">–ü–æ—Å—Ç—ã</h3>
    <a href="{{ url_for('add_post') }}" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</a>
  </div>

  <form method="get" class="form-inline mb-3">
    <label for="category_id" class="mr-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
    <select
      id="category_id"
      name="category_id"
      class="form-control select2 mr-2"
      style="width: 250px;"
      data-placeholder="–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
      onchange="this.form.submit()"
    >
      <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      {% for cat, lvl in tree %}
        <option
          value="{{ cat.id }}"
          data-level="{{ lvl }}"
          {% if cat.id == selected_category %}selected{% endif %}
        >
          {{ cat.name }}
        </option>
      {% endfor %}
    </select>
    <noscript><button type="submit" class="btn btn-primary">–§–∏–ª—å—Ç—Ä</button></noscript>
  </form>

  <table class="table table-striped table-bordered">
    <thead class="thead-light">
      <tr>
        <th style="width: 5%;">ID</th>
        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
        <th>–°—Å—ã–ª–∫–∞</th>
        <th style="width: 15%;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
        <th style="width: 10%;">–ê—Ä—Ö–∏–≤</th>
        <th style="width: 20%;">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for p in posts %}
      <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.title }}</td>
        <td>
          <a href="{{ p.link }}" target="_blank" rel="noopener noreferrer">{{ p.link }}</a>
        </td>
        <td>{{ p.category.name if p.category else "‚Äî" }}</td>
        <td>
          {% if p.archived %}
            <span class="badge badge-secondary">–î–∞</span>
          {% else %}
            <span class="badge badge-success">–ù–µ—Ç</span>
          {% endif %}
        </td>
        <td>
          <a href="{{ url_for('edit_post', post_id=p.id) }}" class="btn btn-sm btn-warning">
            ‚úèÔ∏è
          </a>
          <form
            method="post"
            action="{{ url_for('delete_post', post_id=p.id) }}"
            style="display:inline-block;"
            onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç ‚Ññ{{ p.id }}?');"
          >
            <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
          </form>
          {% if p.archived %}
          <form
            method="post"
            action="{{ url_for('unarchive_post', post_id=p.id) }}"
            style="display:inline-block;"
          >
            <button class="btn btn-sm btn-info">‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </form>
          {% else %}
          <form
            method="post"
            action="{{ url_for('archive_post', post_id=p.id) }}"
            style="display:inline-block;"
          >
            <button class="btn btn-sm btn-secondary">üì• –í –∞—Ä—Ö–∏–≤</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    $(document).ready(function() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      $('.select2').select2({
        width: 'resolve',
        placeholder: function(){
          return $(this).data('placeholder');
        },
        allowClear: true,
        escapeMarkup: function(m){ return m; },
        templateResult: function(opt){
          if (!opt.element) return opt.text;
          var lvl = $(opt.element).data('level')||0;
          var indent = '&nbsp;'.repeat(lvl*2);
          var icon = lvl===0 ? 'üìÅ ' : 'üìÑ ';
          return $('<span>').html(indent+icon+opt.text);
        },
        templateSelection: function(opt){ return opt.text; }
      });
    });
  </script>
{% endblock %}
